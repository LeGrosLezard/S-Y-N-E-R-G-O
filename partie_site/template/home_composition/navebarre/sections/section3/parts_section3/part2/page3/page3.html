<div class="section3_part2_page" id="section3_part2_part3">


    <span id="span4"
        onclick="scrolling('false', 'true', '#section3_part2_part3', '#section3_part2_part2')">
            Page précédente
    </span>



    <div id="animation_s3_p2_p3">



        <img id="img_video_s3_p2_p3"
            src="https://img.icons8.com/material-outlined/24/000000/video.png">

        <img id="img_camera_s3_p2_p3"
            src="https://img.icons8.com/ios-filled/50/000000/camcorder.png">

        <p id="animation_p_p3_s3_p3_p2"></p>


        <div id="camering">

            <p><button id="btnStart">START RECORDING</button><br/>
            <button id="btnStop">STOP RECORDING</button></p>

            <video controls style="width:20%;"></video>
            <video id="vid2" style="width:20%;" controls></video>
            <video controls="" autoplay="autoplay" id="video_treated" style="border:2px solid blue;display:none;"></video>

            <input type="button" id="secret_button_ajax_camera" style="display:none;">
            <p id="secret_p_camera" style="border:1px solid red;">{{ video_blob }}</p>


            <video id="playerVideo" width="320" height="240" style="border:1px solid red;"autoplay="autoplay" muted>
              Your browser does not support the video tag.
            </video>








        </div>





        <div id="uploading">
            <e id="iframe_uploading"
                width="49%" height="180px" scrolling="no" frameBorder="0" src='/download'></iframe>
    
            <div id="explication_upload_p3_p2">
                <ul>
                    <li>1 - </li>
                    <li>2 - </li>
                    <li>3 - </li>
                    <li>4 - </li>
                    
                </ul>
            </div>
        </div>



    </div>

    


    <div id="s3_p2_p3_button">


        <div id="video_s3_p2_p3" onclick="choice_animation('Synergo Caméra', 'camera')">
            <center>
                <svg width="180" height="50" id="svg_video_s3_p2_p3">
                    <rect x="0" y="0" rx="5" ry="5" width="180" height="50" stroke="white" stroke-width="3" fill="none"/>
                    <text class="svg_text" x="50%" y="50%" alignment-baseline="middle" text-anchor="middle" fill="white">
                        J'essaie avec ma webcam.
                    </text>    
                </svg>
            </center>
        </div>




        <div id="camera_s3_p2_p3" onclick="choice_animation('Synergo Vidéo', 'video')">
            <center>
                <svg width="180" height="50" id="svg_cam_s3_p2_p3">
                    <rect x="0" y="0" rx="5" ry="5" width="180" height="50" stroke="white" stroke-width="3" fill="none"/>
                    <text class="svg_text" x="50%" y="50%" alignment-baseline="middle" text-anchor="middle" fill="white">
                        J'essaie avec ma vidéo.
                    </text>    
                </svg>
            </center>

        </div>



    </div>


























</div>


<style>


    #cam{
        margin-top:10%;
        width:40%;
        height:60%;
        border:2px solid black;
    }
    #camering{
        position:absolute;
        width:100%;
        height:100%;
        z-index:20000000000000000000000;
        opacity:0;
        -webkit-transition: opacity 2s;
        -moz-transition: opacity 2s;
        -o-transition: opacity 2s;
        transition: opacity 2s;
    }
    li{
        text-align:left;
    }
    #iframe_uploading{
        float:left;
    }
    #explication_upload_p3_p2{
        float:right;
        width:50%;
        height:100%;
    }
    #uploading{
        top:30%;
        left:0;
        height:100%;
        position:absolute;
        width:100%;
        margin:0;
        padding:0;

        opacity:0;
        -webkit-transition: opacity 2s;
        -moz-transition: opacity 2s;
        -o-transition: opacity 2s;
        transition: opacity 2s;

    }
    #animation_s3_p2_p3{
        position:absolute;
        width:100%;
        height:100%;
        margin:0;
        padding:0;
        opacity:0;
        -webkit-transition: opacity 2s;
        -moz-transition: opacity 2s;
        -o-transition: opacity 2s;
        transition: opacity 2s;
    }
    .svg_text{
        color:white;
        stroke:none;
    }
    #svg_video_s3_p2_p3:hover{
        stroke-dashoffset: 451;
        stroke:#2D3142;
        cursor:pointer;
    }
    #svg_cam_s3_p2_p3:hover{
        stroke-dashoffset: 451;
        stroke:#2D3142;
        cursor:pointer;
    }
    #svg_video_s3_p2_p3{
        stroke-dasharray: 451;
        transition: 1.5s;
    }
    #svg_cam_s3_p2_p3{
        stroke-dasharray: 451;
        transition: 1.5s;
    }
    #camera_s3_p2_p3{
        position:relative;
        width:50%;
        float:left;
    }
    #video_s3_p2_p3{
        position:relative;
        width:50%;
        float:right;
    }
    #img_camera_s3_p2_p3{
        position:absolute;
        width:5%;
        margin-top:15%;
        margin-right:50%;
        
        opacity:0;
        -webkit-transition: opacity 2s;
        -moz-transition: opacity 2s;
        -o-transition: opacity 2s;
        transition: opacity 2s;

    }
    #img_video_s3_p2_p3{
        position:absolute;
        width:5%;
        margin-top:15%;
        left:48%;
        opacity:0;
        -webkit-transition: opacity 2s;
        -moz-transition: opacity 2s;
        -o-transition: opacity 2s;
        transition: opacity 2s;

    }
    #s3_p2_p3_button{
        position:relative;
        width:100%;
        margin:0;
        padding:0;
        margin-top:5%;
        height:100%;
    }

    #span4{
        cursor:pointer;
        color:white;
    }
    #section3_part2_part3{
        color:white;
    }
    #animation_p_p3_s3_p3_p2{
        position:absolute;
        width:100%;
        color:white;
        letter-spacing:2px;
        font-weight:bold;
        top:35%;

        opacity:0;
        -webkit-transition: opacity 2s;
        -moz-transition: opacity 2s;
        -o-transition: opacity 2s;
        transition: opacity 2s;
    }
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/core.js"></script>
<script type="text/javascript" src="static/download_master/download.js"></script>
<script type="text/javascript" src="static/download_master/download.min"></script>

<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>

<script>



    function raise_(element){
        setTimeout(function(){
             document.getElementById(element).style.opacity = "0";
            }, 1500)
    };

    function increase_size(element){
        document.getElementById(element).style.width = "10%";
        document.getElementById(element).style.opacity = "1";
    };

    function animation_start(text, mode){

        document.getElementById("animation_p_p3_s3_p3_p2").innerHTML = "";
        document.getElementById("animation_s3_p2_p3").style.opacity = "1";

        if (mode == "video"){
            document.getElementById("img_camera_s3_p2_p3").style.opacity = "0";
            document.getElementById("img_video_s3_p2_p3").style.opacity = "1";
            raise_("img_video_s3_p2_p3");

            setTimeout(function(){
                document.getElementById("animation_p_p3_s3_p3_p2").innerHTML = text;
                document.getElementById("animation_p_p3_s3_p3_p2").style.opacity = "1";
            }, 3000)


            setTimeout(function(){
                document.getElementById("animation_p_p3_s3_p3_p2").style.opacity = "0";
                mode_video();
            }, 4500)

            
        };

        if (mode == "camera"){
            document.getElementById("img_video_s3_p2_p3").style.opacity = "0";
            document.getElementById("img_camera_s3_p2_p3").style.opacity = "1";
            raise_("img_camera_s3_p2_p3");


            setTimeout(function(){
                document.getElementById("animation_p_p3_s3_p3_p2").innerHTML = text;
                document.getElementById("animation_p_p3_s3_p3_p2").style.opacity = "1";
            }, 1)


            setTimeout(function(){
                document.getElementById("animation_p_p3_s3_p3_p2").style.opacity = "0";
                mode_camera();
            }, 1)

        };

    };


    function mode_camera(){
        document.getElementById("camering").style.opacity = "1";

    };

    function mode_video(){
        document.getElementById("uploading").style.opacity = "1";
    };

    function choice_animation(text, mode){
        animation_start(text, mode);
    };



    function setVideo(blob)
    {
        console.log(blob)
        uploadAudio(blob)
    }


    function uploadAudio(data_blob)
    {
        console.log(data_blob)
        var reader = new FileReader();
        reader.onload = function(event)
        {
            var fd = new FormData();
            var mp4name = encodeURIComponent('video_recording_' + new Date().getTime() + '.mp4');
            console.log("mp4name = " + mp4name);
            fd.append('fname', mp4name);
            fd.append('data', event.target.result);
            $.ajax({
                    type: 'POST',
                    headers: { "X-CSRFToken": getCookie("csrftoken") },
                    url: 'download',
                    data: fd,
                    processData: false,
                    contentType: false

            }).done(function(data) {
                console.log(data);

                const video_treated = document.getElementById("secret_p_camera").innerHTML = data["results"];
                //document.getElementById("video_treated").src = video_treated;
                //document.getElementById("video_treated").style.display = "block";

                
                });
        };      
        reader.readAsDataURL(data_blob);
    };




    $("#secret_button_ajax_camera").click(function()
    {


        setTimeout(function()
        {
        
        var xhr = new XMLHttpRequest();
        xhr.responseType = 'blob';

        xhr.onload = function()
        {
            setVideo(xhr.response);
        };



            var url = document.getElementById("vid2").src;
            console.log(url)
            xhr.open('GET', url);
            xhr.send();
 
        }, 1 );
    });






</script>






 <script>
        
    let constraintObj = { 
        audio: false, 
        video: { 
            facingMode: "user", 
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 } 
        } 
    }; 

    //handle older browsers that might implement getUserMedia in some way
    if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
        navigator.mediaDevices.getUserMedia = function(constraintObj) {
            let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            if (!getUserMedia) {
                return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
            }
            return new Promise(function(resolve, reject) {
                getUserMedia.call(navigator, constraintObj, resolve, reject);
            });
        }
    }else{
        navigator.mediaDevices.enumerateDevices()
        .then(devices => {
            devices.forEach(device=>{
                console.log(device.kind.toUpperCase(), device.label);
                //, device.deviceId
            })
        })
        .catch(err=>{
            console.log(err.name, err.message);
        })
    }

    navigator.mediaDevices.getUserMedia(constraintObj)
    .then(function(mediaStreamObj) {
        //connect the media stream to the first video element
        let video = document.querySelector('video');
        if ("srcObject" in video) {
            video.srcObject = mediaStreamObj;
        } else {
            //old version
            video.src = window.URL.createObjectURL(mediaStreamObj);
        }
        
        video.onloadedmetadata = function(ev) {
            //show in the video element what is being captured by the webcam
            video.play();
        };
        
        //add listeners for saving video/audio
        let start = document.getElementById('btnStart');
        let stop = document.getElementById('btnStop');
        let vidSave = document.getElementById('vid2');
        let mediaRecorder = new MediaRecorder(mediaStreamObj);
        let chunks = [];
        
        start.addEventListener('click', (ev)=>{
            mediaRecorder.start();
            console.log(mediaRecorder.state);
        })
        stop.addEventListener('click', (ev)=>{
            mediaRecorder.stop();
            console.log(mediaRecorder.state);
            document.getElementById("secret_button_ajax_camera").click();
            console.log("clicked")

        });
        mediaRecorder.ondataavailable = function(ev) {
            chunks.push(ev.data);
        }
        mediaRecorder.onstop = (ev)=>{
            let blob = new Blob(chunks, { 'type' : 'video/mp4;' });
            chunks = [];
            let videoURL = window.URL.createObjectURL(blob);
            vidSave.src = videoURL;
        }
    })
    .catch(function(err) { 
        console.log(err.name, err.message); 
    });
    
    /*********************************
    getUserMedia returns a Promise
    resolve - returns a MediaStream Object
    reject returns one of the following errors
    AbortError - generic unknown cause
    NotAllowedError (SecurityError) - user rejected permissions
    NotFoundError - missing media track
    NotReadableError - user permissions given but hardware/OS error
    OverconstrainedError - constraint video settings preventing
    TypeError - audio: false, video: false
    *********************************/



    function getCookie(c_name)
    {
        if (document.cookie.length > 0)
        {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1)
            {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start,c_end));
            }
        }
        return "";
     }


    $.cookie('cookiename', 'cookievalue');
    // read cookie
    var myCookie = $.cookie('cookiename');
    // delete cookie
    $.cookie('cookiename', null);








</script>
